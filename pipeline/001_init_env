podTemplate(name: 'stx-build-init', cloud: 'kubernetes',
  namespace: 'devops', label: 'stx-build-init',
  serviceAccount: 'default', containers: [
  containerTemplate(
      name: 'stx-build-init',
      image: 'kunpeng4code/stx-builder:centos-base',
      ttyEnabled: true,
      privileged: false,
      alwaysPullImage:true
      )
  ],
  volumes: [
    hostPathVolume(mountPath: '/opt/jenkins', hostPath: '/opt/jenkins')
  ]) {
  node("stx-build-init"){
    stage('git clone tools') {
      container('stx-build-init') {
          sh """
            if [ -d "/opt/jenkins/tools" ]; then
                cd /opt/jenkins/tools
                git pull
            else
                git clone -v https://opendev.org/starlingx/tools.git /opt/jenkins/tools --depth 1 --branch master
            fi
          """
      }
    }
    stage('download mirrors') {
      container('stx-build-init') {
          sh """
            if [ -d "/opt/jenkins/tools/centos-mirror-tools/output" ];then
                cd /opt/jenkins/tools/centos-mirror-tools/
                bash download_mirror.sh
            else
                cp -r /opt/jenkins/output /opt/jenkins/tools/centos-mirror-tools/output
                cd /opt/jenkins/tools/centos-mirror-tools/
                bash download_mirror.sh
            fi
            cp -rf /opt/jenkins/tools/centos-mirror-tools/output/* /opt/jenkins/output/.
          """
      } 
    }
    stage('init repo'){
        container('stx-build-init') {
          sh """
            cd /opt/jenkins/
            repo init -u https://opendev.org/starlingx/manifest -m default.xml
            repo sync --force-sync
          """
        }
    }
    stage('generate centos repo') {
      container('stx-build-init') {
          sh """
            CGCS_REPO=/opt/jenkins/mirror/centos/cgcs-centos-repo
            mkdir -p $CGCS_REPO
            cp -rf /opt/jenkins/output/stx-r1/CentOS/pike/* $CGCS_REPO
            cp -f /opt/jenkins/cgcs-root/build-tools/repo_files/comps.xml $CGCS_REPO/Binary/comps.xml
            cd $CGCS_REPO/Binary/
            createrepo -g comps.xml .
          """
      } 
    }
  }
}